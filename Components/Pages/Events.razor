@page "/events"
@using SolCentre.Models
@inject SolCentre.Services.IEonetService EonetService
@inject ILogger<Events> Logger

<h3>EONET Events</h3>

<div class="events-controls mb-3 d-flex flex-wrap gap-3">
    <div>
        <label class="form-label">Status</label>
        <select @bind="SelectedStatus" class="form-select" style="width:10rem">
            <option value="">All</option>
            <option value="open">Open</option>
            <option value="closed">Closed</option>
        </select>
    </div>

    <div>
        <label class="form-label">Days</label>
        @* How many past days to include when querying the API *@
        <input type="number" @bind="Days" class="form-control d-inline-block ms-2" style="width:6rem" min="1" />
    </div>

    <div>
        <label class="form-label">Limit</label>
        @* Maximum number of events to request from the API *@
        <input type="number" @bind="Limit" class="form-control d-inline-block ms-2" style="width:6rem" min="1" max="200" />
    </div>

    <div>
        <label class="form-label">Category</label>
        @* Filter by category *@
        <select @bind="SelectedCategory" class="form-select ms-2" style="width:12rem">
            <option value="">All categories</option>
            @foreach (var c in Categories)
            {
                <option value="@c">@c</option>
            }
        </select>
    </div>

    <div>
        @* Manual reload button to re-run the query with the selected filters *@
        <button class="btn btn-primary ms-2" @onclick="Load">Load</button>
    </div>
</div>

@* --- Error/null states --- *@
@if (!string.IsNullOrEmpty(LastError))
{
    @* Show error message when loading fails *@
    <div class="alert alert-danger"><strong>Error:</strong> @LastError</div>
}
else if (IsLoading)
{
    <p>Loading…</p>
}
else if (FilteredEvents == null || FilteredEvents.Count == 0)
{
    @* Inform the user when no events match the current filters *@
    <p>No events found.</p>
}
else
{
    @* --- Events list and detail layout (left = list, right = detail) --- *@
    <div class="row">
        <div class="col-md-5">
            @foreach (var ev in FilteredEvents)
            {
                <div class="card mb-2" role="button" tabindex="0"
                     @onclick="() => SelectEvent(ev.Id)"
                     @onkeydown="@(e => { if (e.Key == "Enter" || e.Key == " ") SelectEvent(ev.Id); })"
                     style="cursor:pointer">
                    <div class="card-body">
                        <h5 class="card-title">@ev.Title</h5>
                        <p class="card-text">
                            <strong>Category:</strong> @ev.Categories?.FirstOrDefault()?.Title ?? "—"
                            <br />
                            <small>@(ev.Closed == null ? "Open" : $"Closed: {ev.Closed?.ToLocalTime():g}")</small>
                        </p>
                    </div>
                </div>
            }
        </div>

        <div class="col-md-7">
            @if (!string.IsNullOrEmpty(SelectedEventId))
            {
                <EventDetail EventId="@SelectedEventId" />
            }
            else
            {
                <p class="text-muted">Select an event to view details.</p>
            }
        </div>
    </div>
}

@code {
    // Events fetched from the EONET API
    private List<EonetEvent> EventsList = new();

    // Events after applying the current client-side filters
    private List<EonetEvent> FilteredEvents = new();

    private bool IsLoading;                
    private string LastError;             
    private string SelectedStatus = "open";
    private int Days = 30;                 
    private int Limit = 50;              
    private string SelectedCategory = "";  
    private string SelectedEventId;      
    private List<string> Categories = new();

    //   load events on component initialization
    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    // Load events from the EonetService, build categories, apply filter, and auto-select first item.
    private async Task Load()
    {
        IsLoading = true;
        LastError = null;

        try
        {
            Logger.LogInformation("Loading events: days={days}, status={status}", Days, SelectedStatus);

            // Call the service to get events with the chosen filters
            var api = await EonetService.GetEventsAsync(limit: Limit, days: Days, status: string.IsNullOrWhiteSpace(SelectedStatus) ? null : SelectedStatus);

            // Ensure we have a non-null list to work with
            EventsList = api?.ToList() ?? new List<EonetEvent>();

            Categories = EventsList
                .SelectMany(e => e.Categories ?? Enumerable.Empty<EonetCategory>())
                .Select(c => c.Title)
                .Where(t => !string.IsNullOrWhiteSpace(t))
                .Distinct()
                .OrderBy(t => t)
                .ToList();

            // Apply client-side category filter to the loaded events
            ApplyFilter();

            // Auto-select the first event to show details immediately
            if (string.IsNullOrEmpty(SelectedEventId) && FilteredEvents.Any())
            {
                SelectedEventId = FilteredEvents.First().Id;
            }
        }
        catch (Exception ex)
        {
            // Log the exception
            Logger.LogError(ex, "Failed to load events");
            LastError = ex.Message;
            EventsList = new List<EonetEvent>();
            FilteredEvents = new List<EonetEvent>();
        }
        finally
        {
            // Clear loading flag and request a UI update
            IsLoading = false;
            StateHasChanged();
        }
    }

    // Apply the category filter; show all events when no category selected
    private void ApplyFilter()
    {
        if (string.IsNullOrWhiteSpace(SelectedCategory))
        {
            FilteredEvents = EventsList;
        }
        else
        {
            FilteredEvents = EventsList
                .Where(e => e.Categories?.Any(c => c.Title == SelectedCategory) == true)
                .ToList();
        }
    }

    // Set the selected event id
    private void SelectEvent(string id)
    {
        SelectedEventId = id;
        Logger.LogInformation("Selected event {id}", id);
    }

    private string _selectedCategoryBacking;
    private string SelectedCategoryBacking
    {
        get => _selectedCategoryBacking;
        set
        {
            _selectedCategoryBacking = value;
            SelectedCategory = value;
            ApplyFilter();
        }
    }
}
